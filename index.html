<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RadioMaster Ultimate</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- HLS.js per flussi avanzati (es. m3u8) -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#09090b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link id="manifest-placeholder" rel="manifest">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: { 
                        accent: 'var(--accent-color)', 
                        'accent-dim': 'var(--accent-dim)',
                        'skin-bg': 'var(--bg-color)',
                        'skin-panel': 'var(--panel-color)',
                        'skin-text': 'var(--text-main)',
                        'skin-text-dim': 'var(--text-dim)',
                        'skin-border': 'var(--border-color)'
                    }
                }
            }
        }
    </script>

    <style>
        :root { 
            --accent-color: #22c55e; 
            --accent-dim: rgba(34, 197, 94, 0.2);
            --bg-color: #09090b;
            --panel-color: #18181b;
            --text-main: #f4f4f5;
            --text-dim: #a1a1aa;
            --border-color: rgba(255, 255, 255, 0.05);
        }

        body { 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            transition: background-color 0.4s, color 0.4s; 
            overflow-x: hidden; 
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 99px; }
        
        .glass { 
            background: rgba(var(--panel-rgb, 24, 24, 27), 0.6); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px); 
            border: 1px solid var(--border-color); 
        }
        .glass-panel { background: var(--panel-color); border: 1px solid var(--border-color); }

        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 var(--accent-dim); } 70% { box-shadow: 0 0 0 10px transparent; } 100% { box-shadow: 0 0 0 0 transparent; } }
        .recording-dot { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #fff; margin-top: -6px; box-shadow: 0 2px 6px rgba(0,0,0,0.5); cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; border-radius: 2px; background: #3f3f46; }
        
        #party-overlay { transition: opacity 0.5s, transform 0.5s; pointer-events: none; opacity: 0; transform: scale(0.95); }
        body.party-active #party-overlay { pointer-events: auto; opacity: 1; transform: scale(1); }
        body.party-active main, body.party-active header { filter: blur(20px); opacity: 0; pointer-events: none; }

        input[type="color"] { -webkit-appearance: none; border: none; width: 32px; height: 32px; border-radius: 50%; overflow: hidden; padding: 0; background: none; cursor: pointer; }
    </style>
</head>
<body class="selection:bg-accent selection:text-black">

    <!-- PARTY MODE OVERLAY (FULL SCREEN CONSOLE) -->
    <div id="party-overlay" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center p-6 text-center">
        <canvas id="party-canvas" class="absolute inset-0 w-full h-full opacity-60"></canvas>
        
        <!-- Top Right Controls -->
        <div class="absolute top-6 right-6 z-20 flex gap-4">
            <!-- Cycle Visualizer -->
            <button onclick="app.ui.cycleVisualizer()" class="w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 backdrop-blur text-white transition-all shadow-lg" title="Cambia Visualizzatore">
                <i id="party-vis-icon" class="fa-solid fa-chart-simple"></i>
            </button>
            <!-- Change Accent Color -->
            <div class="relative group">
                <button class="w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 backdrop-blur text-white transition-all shadow-lg" title="Cambia Colore">
                    <i class="fa-solid fa-palette"></i>
                </button>
                <input type="color" oninput="app.ui.setAccent(this.value)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
            </div>
            <!-- Exit -->
            <button onclick="app.ui.togglePartyMode()" class="w-12 h-12 rounded-full bg-white/10 hover:bg-red-500/80 backdrop-blur text-white transition-all shadow-lg">
                <i class="fa-solid fa-compress"></i>
            </button>
        </div>

        <div class="relative z-10 space-y-6 max-w-4xl w-full">
            <img id="party-logo" src="" class="w-40 h-40 md:w-56 md:h-56 mx-auto rounded-3xl shadow-[0_0_50px_rgba(0,0,0,0.5)] object-cover border-4 border-white/10 hidden animate-pulse">
            <div class="space-y-1">
                <h1 id="party-track" class="text-5xl md:text-7xl font-black text-white tracking-tighter drop-shadow-2xl truncate">RadioMaster</h1>
                <p id="party-station" class="text-xl md:text-2xl text-accent font-mono uppercase tracking-widest opacity-80">Ultimate Edition</p>
            </div>
            
            <!-- Main Controls -->
            <div class="flex flex-col items-center gap-8 mt-12">
                <div class="flex items-center gap-10">
                    <button onclick="app.prevChannel()" class="text-white/40 hover:text-white text-5xl transition-all hover:scale-110 active:scale-95" title="Canale Precedente">
                        <i class="fa-solid fa-backward-step"></i>
                    </button>
                    
                    <button onclick="app.audio.togglePlay()" class="w-24 h-24 bg-white text-black rounded-full flex items-center justify-center text-4xl hover:scale-105 active:scale-95 transition-all shadow-[0_0_30px_rgba(255,255,255,0.4)]">
                        <i id="party-play-icon" class="fa-solid fa-pause ml-1"></i>
                    </button>
                    
                    <button onclick="app.nextChannel()" class="text-white/40 hover:text-white text-5xl transition-all hover:scale-110 active:scale-95" title="Canale Successivo">
                        <i class="fa-solid fa-forward-step"></i>
                    </button>
                </div>

                <!-- Volume Slider Fullscreen -->
                <div class="w-full max-w-md flex items-center gap-4 px-4 bg-black/30 backdrop-blur-md rounded-full py-3 border border-white/5">
                    <i class="fa-solid fa-volume-low text-white/50 text-xs"></i>
                    <input type="range" id="party-vol-slider" min="0" max="1" step="0.01" value="0.8" class="w-full h-1.5 bg-white/20 rounded-full appearance-none cursor-pointer accent-white">
                    <i class="fa-solid fa-volume-high text-white/50 text-xs"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="glass sticky top-0 z-50 border-b border-skin-border">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-wave-square text-accent text-2xl animate-pulse"></i>
                <h1 class="text-xl font-bold tracking-tight hidden sm:block text-skin-text">Radio<span class="text-accent">Master</span></h1>
            </div>
            
            <div class="flex items-center gap-2">
                <!-- PWA Install Button -->
                <button id="install-btn" class="hidden flex items-center gap-2 bg-accent text-black px-4 py-2 rounded-full text-xs font-black uppercase hover:scale-105 transition-all shadow-lg shadow-accent/20">
                    <i class="fa-solid fa-download"></i> <span>INSTALLA APP</span>
                </button>
                <button onclick="app.ui.togglePartyMode()" class="p-2 rounded-full hover:bg-black/10 transition-colors" title="Party Mode">
                    <i class="fa-solid fa-expand text-skin-text"></i>
                </button>
                <button onclick="app.audio.toggleRecording()" id="rec-btn" class="flex items-center gap-2 px-3 py-1.5 rounded-full border border-red-500/30 text-red-500 hover:bg-red-500/10 transition-all text-xs font-bold uppercase tracking-wider">
                    <div class="w-2 h-2 rounded-full bg-red-500" id="rec-dot"></div> <span id="rec-text">REC</span>
                </button>
                <div class="hidden md:flex items-center gap-2 bg-black/5 px-3 py-1 rounded-full border border-skin-border text-xs font-mono text-skin-text-dim">
                    <i class="fa-regular fa-clock text-accent"></i> <span id="clock-display">--:--</span>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="max-w-7xl mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6 transition-all duration-500">
        
        <!-- LEFT COLUMN: Player & Visuals -->
        <section class="lg:col-span-7 flex flex-col gap-6">
            <div class="glass rounded-3xl p-1 relative overflow-hidden shadow-2xl group">
                <canvas id="main-visualizer" class="absolute inset-0 w-full h-full opacity-30"></canvas>
                <div class="relative bg-gradient-to-b from-black/0 to-black/80 p-6 sm:p-8 rounded-[22px] flex flex-col justify-end min-h-[300px]">
                    <div class="flex items-end gap-6 mb-8">
                        <div class="w-24 h-24 sm:w-32 sm:h-32 rounded-2xl bg-zinc-900 shadow-2xl border border-white/10 flex-shrink-0 overflow-hidden relative">
                            <img id="player-img" src="" class="w-full h-full object-cover hidden">
                            <div id="player-placeholder" class="w-full h-full flex items-center justify-center text-zinc-700 text-4xl"><i class="fa-solid fa-music"></i></div>
                        </div>
                        <div class="flex-1 min-w-0 pb-2">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-accent text-black uppercase tracking-wider">Live</span>
                                <span id="player-bitrate" class="text-[10px] text-zinc-300 font-mono tracking-widest uppercase">HD Audio Stream</span>
                            </div>
                            <h2 id="player-title" class="text-3xl sm:text-4xl font-black text-white leading-none mb-2 truncate tracking-tight">Sintonizzati</h2>
                            <p id="player-subtitle" class="text-zinc-300 text-sm sm:text-base font-medium truncate">Seleziona una sorgente</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 sm:gap-6">
                        <button onclick="app.audio.togglePlay()" id="main-play-btn" class="w-16 h-16 rounded-full bg-accent text-black flex items-center justify-center text-xl hover:scale-105 active:scale-95 transition-all shadow-lg">
                            <i class="fa-solid fa-play ml-1"></i>
                        </button>
                        <div class="flex-1 flex flex-col gap-2">
                            <div class="flex items-center justify-between text-xs font-bold text-zinc-300 uppercase tracking-widest px-1">
                                <span>Volume</span>
                                <button onclick="app.ui.toggleEqPanel()" class="hover:text-white transition-colors text-[10px] uppercase font-black tracking-widest"><i class="fa-solid fa-sliders mr-1 text-accent"></i> Studio FX</button>
                            </div>
                            <div class="relative h-10 bg-white/10 rounded-full border border-white/5 flex items-center px-4 gap-3">
                                <i id="vol-icon" class="fa-solid fa-volume-low text-white text-xs"></i>
                                <input type="range" id="vol-slider" min="0" max="1" step="0.01" value="0.8" class="w-full h-full accent-accent">
                            </div>
                        </div>
                    </div>
                    <audio id="audio-element" crossorigin="anonymous"></audio>
                </div>
            </div>

            <!-- FX PANEL -->
            <div id="eq-panel" class="hidden glass-panel rounded-2xl p-6 shadow-xl border-l-4 border-accent">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-skin-text flex items-center gap-2 uppercase tracking-tighter"><i class="fa-solid fa-sliders text-accent"></i> Studio Equalizzatore</h3>
                    <button onclick="app.audio.resetEq()" class="text-[10px] text-skin-text-dim hover:text-skin-text uppercase font-black tracking-widest">Reset EQ</button>
                </div>
                <div class="grid grid-cols-4 gap-4 text-center">
                    <div class="space-y-3">
                        <input type="range" id="eq-low" min="-12" max="12" value="0" class="h-24 -rotate-90 w-full block accent-accent cursor-pointer">
                        <label class="text-[10px] font-black text-skin-text-dim uppercase tracking-widest block pt-8">Bassi</label>
                    </div>
                    <div class="space-y-3">
                        <input type="range" id="eq-mid" min="-12" max="12" value="0" class="h-24 -rotate-90 w-full block accent-accent cursor-pointer">
                        <label class="text-[10px] font-black text-skin-text-dim uppercase tracking-widest block pt-8">Medi</label>
                    </div>
                    <div class="space-y-3">
                        <input type="range" id="eq-high" min="-12" max="12" value="0" class="h-24 -rotate-90 w-full block accent-accent cursor-pointer">
                        <label class="text-[10px] font-black text-skin-text-dim uppercase tracking-widest block pt-8">Alti</label>
                    </div>
                    <div class="flex flex-col justify-end space-y-2">
                        <button id="comp-btn" onclick="app.audio.toggleCompressor()" class="w-12 h-12 mx-auto rounded-xl bg-black/40 border border-skin-border text-skin-text-dim hover:text-accent transition-all flex items-center justify-center shadow-lg"><i class="fa-solid fa-wave-square"></i></button>
                        <label class="text-[10px] font-black text-skin-text-dim uppercase tracking-widest leading-none">Limiter</label>
                    </div>
                </div>
            </div>

            <!-- LIBRARY -->
            <div class="glass rounded-3xl p-6 shadow-xl flex-1 flex flex-col min-h-[400px]">
                <div class="flex gap-4 mb-6 border-b border-skin-border pb-2">
                    <button onclick="app.ui.switchTab('library')" id="tab-btn-library" class="text-lg font-bold text-skin-text border-b-2 border-accent pb-2 transition-all">I Miei Canali</button>
                    <button onclick="app.ui.switchTab('global')" id="tab-btn-global" class="text-lg font-bold text-skin-text-dim hover:text-skin-text border-b-2 border-transparent pb-2 transition-all">Web Mondo</button>
                </div>
                <div id="view-library" class="flex-1 flex flex-col">
                    <div class="flex justify-between items-center mb-4 px-1">
                        <span id="library-count" class="text-[10px] font-bold text-skin-text-dim uppercase tracking-widest">0 Stazioni</span>
                        <button onclick="app.ui.openAddChannel()" class="bg-accent text-black px-4 py-1.5 rounded-lg text-[10px] font-black uppercase shadow-lg shadow-accent/10">Aggiungi Radio</button>
                    </div>
                    <div id="channel-list" class="grid grid-cols-1 sm:grid-cols-2 gap-3 overflow-y-auto max-h-[500px] pr-2"></div>
                </div>
                <div id="view-global" class="hidden flex-1 flex flex-col">
                    <div class="relative mb-4">
                        <i class="fa-solid fa-search absolute left-4 top-3.5 text-skin-text-dim text-sm"></i>
                        <input type="text" id="global-search" placeholder="Cerca migliaia di radio..." class="w-full bg-black/20 border border-skin-border rounded-xl py-3 pl-10 pr-4 text-sm text-skin-text focus:border-accent outline-none">
                        <button onclick="app.api.search(document.getElementById('global-search').value)" class="absolute right-2 top-2 bg-accent text-black p-1.5 rounded-lg text-xs font-bold px-3">Cerca</button>
                    </div>
                    <div id="global-list" class="space-y-2 overflow-y-auto max-h-[500px] pr-2"></div>
                </div>
            </div>
        </section>

        <!-- RIGHT COLUMN -->
        <section class="lg:col-span-5 flex flex-col gap-6">
            <div class="glass rounded-3xl p-6 shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-skin-text flex items-center gap-2"><i class="fa-solid fa-calendar-check text-accent"></i> Programmazione</h3>
                    <button onclick="app.ui.openModal('modal-schedule')" class="w-8 h-8 rounded-lg bg-skin-border hover:bg-accent hover:text-black flex items-center justify-center text-skin-text-dim transition-colors"><i class="fa-solid fa-plus"></i></button>
                </div>
                <div id="schedule-list" class="space-y-3 max-h-[300px] overflow-y-auto"></div>
            </div>

            <div class="glass rounded-3xl p-6 shadow-xl">
                <h3 class="font-bold text-skin-text mb-4 flex items-center gap-2 uppercase tracking-tighter"><i class="fa-solid fa-toolbox text-blue-500"></i> Utility & Skin</h3>
                
                <div class="bg-black/10 rounded-xl p-4 border border-skin-border mb-4">
                    <label class="text-[10px] font-bold text-skin-text-dim uppercase mb-2 block tracking-widest">Scegli Skin</label>
                    <select id="skin-selector" onchange="app.ui.setSkin(this.value)" class="w-full bg-black/20 border border-skin-border rounded-lg p-2 text-sm text-skin-text outline-none">
                        <option value="midnight">Midnight (Nero)</option>
                        <option value="light">Arctic (Chiaro)</option>
                        <option value="cyber">Cyber Neon</option>
                        <option value="ocean">Ocean (Blu)</option>
                        <option value="retro">Vintage (Crema)</option>
                    </select>
                </div>

                <div class="bg-black/10 rounded-xl p-4 border border-skin-border mb-4">
                    <label class="text-[10px] font-bold text-skin-text-dim uppercase mb-2 block tracking-widest">Stile Visualizzatore</label>
                    <div class="flex gap-1 bg-black/30 p-1 rounded-xl">
                        <button onclick="app.ui.setVisualizer('bars')" class="flex-1 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all" id="vis-btn-bars">Barre</button>
                        <button onclick="app.ui.setVisualizer('wave')" class="flex-1 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all" id="vis-btn-wave">Onda</button>
                        <button onclick="app.ui.setVisualizer('circle')" class="flex-1 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all" id="vis-btn-circle">Cerchio</button>
                    </div>
                </div>

                <div class="bg-black/10 rounded-xl p-4 border border-skin-border">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[10px] font-bold text-skin-text-dim uppercase tracking-widest">Sleep Timer</label>
                        <span id="sleep-countdown" class="text-xs font-mono text-accent hidden">--:--</span>
                    </div>
                    <div class="flex gap-2">
                        <input type="number" id="sleep-input" placeholder="Min" class="w-16 bg-black/20 border border-skin-border rounded-lg p-2 text-center text-sm outline-none">
                        <button onclick="app.tools.setSleep()" class="flex-1 bg-skin-border hover:bg-accent hover:text-black text-skin-text rounded-lg text-xs font-bold uppercase transition-colors">Avvia</button>
                        <button onclick="app.tools.cancelSleep()" class="w-10 bg-skin-border hover:text-red-500 rounded-lg"><i class="fa-solid fa-stop"></i></button>
                    </div>
                </div>
            </div>

            <div class="glass rounded-3xl p-6 shadow-xl mt-auto">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.data.export()" class="p-3 bg-black/10 border border-skin-border rounded-xl text-left transition-all hover:bg-black/20 group">
                        <i class="fa-solid fa-download text-accent mb-1 group-hover:scale-110 transition-transform"></i>
                        <div class="text-[10px] font-bold uppercase">Export JSON</div>
                    </button>
                    <label class="p-3 bg-black/10 border border-skin-border rounded-xl text-left transition-all hover:bg-black/20 cursor-pointer group">
                        <i class="fa-solid fa-upload text-blue-500 mb-1 group-hover:scale-110 transition-transform"></i>
                        <div class="text-[10px] font-bold uppercase">Import JSON</div>
                        <input type="file" hidden onchange="app.data.import(this)">
                    </label>
                </div>
            </div>
        </section>
    </main>

    <!-- MODALE CANALE -->
    <div id="modal-channel" class="fixed inset-0 bg-black/95 backdrop-blur-md z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-zinc-900 border border-zinc-800 rounded-3xl w-full max-w-md p-8 shadow-2xl">
            <h3 class="text-xl font-black text-white mb-6 uppercase tracking-tighter text-center">Configura Stazione</h3>
            <form onsubmit="app.data.saveChannel(event)" class="space-y-4">
                <input type="hidden" name="id">
                <div>
                    <label class="block text-[10px] font-bold text-zinc-500 uppercase mb-1">Nome Radio</label>
                    <div class="flex gap-2">
                        <input type="text" name="name" required class="flex-1 bg-black border border-zinc-700 rounded-xl p-3 text-white outline-none focus:border-accent" placeholder="Radio Name">
                        <button type="button" onclick="app.api.fetchMetaForForm()" class="px-3 bg-zinc-800 text-accent rounded-xl" title="Cerca Logo"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
                    </div>
                </div>
                <div class="grid grid-cols-4 gap-4">
                    <div class="col-span-3">
                        <label class="block text-[10px] font-bold text-zinc-500 uppercase mb-1">URL Logo</label>
                        <input type="url" name="logo" class="w-full bg-black border border-zinc-700 rounded-xl p-3 text-white outline-none focus:border-accent">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-zinc-500 uppercase mb-1">Colore</label>
                        <input type="color" name="color" class="w-full h-[46px] rounded-xl border-none cursor-pointer" value="#22c55e">
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-zinc-500 uppercase mb-1">Stream URL (mp3/m3u8)</label>
                    <input type="url" name="url" required class="w-full bg-black border border-zinc-700 rounded-xl p-3 text-white outline-none focus:border-accent">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="app.ui.closeModal('modal-channel')" class="px-4 py-2 text-zinc-500 font-bold uppercase text-[10px]">Annulla</button>
                    <button type="submit" class="px-8 py-2 bg-accent text-black font-black rounded-lg uppercase text-[12px]">Salva Radio</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODALE SCHEDULE -->
    <div id="modal-schedule" class="fixed inset-0 bg-black/95 backdrop-blur-md z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-zinc-900 border border-zinc-800 rounded-3xl w-full max-w-md p-8 shadow-2xl">
            <h3 class="text-xl font-black text-white mb-6 uppercase text-center">Nuovo Cambio Orario</h3>
            <form onsubmit="app.data.saveSchedule(event)" class="space-y-4">
                <div><label class="block text-xs font-bold text-zinc-500 uppercase mb-1">Ora Esecuzione</label><input type="time" name="time" required class="w-full bg-black border border-zinc-700 rounded-xl p-4 text-white text-2xl font-mono focus:border-accent"></div>
                <div><label class="block text-xs font-bold text-zinc-500 uppercase mb-1">Cambia a Canale</label><select name="channelId" id="schedule-select" required class="w-full bg-black border border-zinc-700 rounded-xl p-4 text-white outline-none focus:border-accent"></select></div>
                <div class="flex justify-end gap-3 mt-6"><button type="button" onclick="app.ui.closeModal('modal-schedule')" class="px-4 py-2 text-zinc-500 font-bold uppercase text-[10px]">Annulla</button><button type="submit" class="px-6 py-2 bg-accent text-black font-black rounded-lg uppercase text-[12px]">Pianifica</button></div>
            </form>
        </div>
    </div>

    <script>
        /** MODULE 1: AUDIO ENGINE (HLS, EQ, COMPRESSOR) **/
        class AudioController {
            constructor() {
                this.ctx = null; this.audioElement = document.getElementById('audio-element');
                this.filters = []; this.compressor = null; this.analyser = null;
                this.recorder = null; this.recordingChunks = []; this.isInitialized = false; this.hls = null;
            }
            init() {
                if (this.isInitialized) return;
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
                const source = this.ctx.createMediaElementSource(this.audioElement);
                this.analyser = this.ctx.createAnalyser(); this.analyser.fftSize = 256;
                const gainNode = this.ctx.createGain();
                
                // EQ Setup
                const bands = [100, 1000, 10000]; const types = ['lowshelf', 'peaking', 'highshelf'];
                let prevNode = source;
                this.filters = bands.map((freq, i) => {
                    const filter = this.ctx.createBiquadFilter(); 
                    filter.type = types[i];
                    filter.frequency.value = freq; 
                    filter.gain.value = 0;
                    prevNode.connect(filter); 
                    prevNode = filter; 
                    return filter;
                });

                // Compressor
                this.compressor = this.ctx.createDynamicsCompressor();
                this.compressor.threshold.value = -24; 
                this.compressor.ratio.value = 1; // OFF by default
                prevNode.connect(this.compressor); 
                this.compressor.connect(gainNode);
                
                gainNode.connect(this.analyser); 
                this.analyser.connect(this.ctx.destination);

                // Rec
                const dest = this.ctx.createMediaStreamDestination();
                gainNode.connect(dest); 
                this.recorder = new MediaRecorder(dest.stream);
                this.recorder.ondataavailable = e => this.recordingChunks.push(e.data);
                this.recorder.onstop = () => this.saveRecording();
                this.isInitialized = true;
            }
            setVolume(val) { this.audioElement.volume = val; }
            play(url) {
                if(!url) return; if(!this.isInitialized) this.init(); if(this.ctx.state === 'suspended') this.ctx.resume();
                if (this.hls) { this.hls.destroy(); this.hls = null; }
                const isM3U8 = url.includes('.m3u8') || url.includes('hls');
                if (Hls.isSupported() && isM3U8) {
                    this.hls = new Hls(); this.hls.loadSource(url); this.hls.attachMedia(this.audioElement);
                    this.hls.on(Hls.Events.MANIFEST_PARSED, () => this.audioElement.play().catch(e => {}));
                } else { this.audioElement.src = url; this.audioElement.play().catch(e => {}); }
            }
            togglePlay() {
                if (!this.audioElement.src && app.data.state.channels.length > 0) return app.playChannel(app.data.state.channels[0].id);
                this.audioElement.paused ? this.audioElement.play().catch(e => {}) : this.audioElement.pause();
            }
            setEq(band, val) { if(this.filters[band]) this.filters[band].gain.value = val; }
            resetEq() { this.filters.forEach(f => f.gain.value = 0); ['low','mid','high'].forEach(id => document.getElementById(`eq-${id}`).value = 0); }
            toggleCompressor() {
                const active = this.compressor.ratio.value > 1;
                this.compressor.ratio.value = active ? 1 : 12;
                document.getElementById('comp-btn').classList.toggle('bg-accent', !active);
                document.getElementById('comp-btn').classList.toggle('text-black', !active);
            }
            toggleRecording() {
                if(!this.isInitialized) this.init();
                const btn = document.getElementById('rec-btn');
                if (this.recorder.state === 'inactive') {
                    this.recordingChunks = []; this.recorder.start();
                    document.getElementById('rec-dot').classList.add('recording-dot');
                    btn.classList.add('bg-red-500/20', 'border-red-500');
                    document.getElementById('rec-text').textContent = "STOP";
                } else {
                    this.recorder.stop(); document.getElementById('rec-dot').classList.remove('recording-dot');
                    btn.classList.remove('bg-red-500/20', 'border-red-500');
                    document.getElementById('rec-text').textContent = "REC";
                }
            }
            saveRecording() {
                const blob = new Blob(this.recordingChunks, { type: 'audio/webm' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                a.download = `radio_master_rec_${Date.now()}.webm`; a.click();
            }
        }

        /** MODULE 2: UI CONTROLLER **/
        class UiController {
            constructor() {
                this.visualizerType = 'bars'; this.animationId = null;
                this.visTypes = ['bars', 'wave', 'circle'];
                this.skins = {
                    midnight: { bg: '#09090b', panel: '#18181b', text: '#f4f4f5', dim: '#a1a1aa', border: 'rgba(255,255,255,0.05)', rgb: '24, 24, 27' },
                    light: { bg: '#f8fafc', panel: '#ffffff', text: '#0f172a', dim: '#64748b', border: 'rgba(0,0,0,0.1)', rgb: '255, 255, 255' },
                    cyber: { bg: '#000000', panel: '#0a0a0a', text: '#00ff41', dim: '#008f11', border: 'rgba(0,255,65,0.2)', rgb: '10, 10, 10' },
                    ocean: { bg: '#020617', panel: '#0f172a', text: '#f1f5f9', dim: '#94a3b8', border: 'rgba(56,189,248,0.2)', rgb: '15, 23, 42' },
                    retro: { bg: '#fef3c7', panel: '#fffbeb', text: '#78350f', dim: '#b45309', border: 'rgba(120,53,15,0.1)', rgb: '255, 251, 235' }
                };
            }
            setSkin(name) {
                const s = this.skins[name] || this.skins.midnight;
                const r = document.documentElement;
                r.style.setProperty('--bg-color', s.bg);
                r.style.setProperty('--panel-color', s.panel);
                r.style.setProperty('--text-main', s.text);
                r.style.setProperty('--text-dim', s.dim);
                r.style.setProperty('--border-color', s.border);
                r.style.setProperty('--panel-rgb', s.rgb);
                if(app && app.data && app.data.state) { app.data.state.skin = name; app.data.save(); }
                const selector = document.getElementById('skin-selector');
                if(selector) selector.value = name;
            }
            startVisualizer(analyser) {
                if(this.animationId) cancelAnimationFrame(this.animationId);
                const data = new Uint8Array(analyser.frequencyBinCount);
                const cv = document.getElementById('main-visualizer');
                const pc = document.getElementById('party-canvas');
                const ctx = cv.getContext('2d'); const pCtx = pc.getContext('2d');
                const draw = () => {
                    this.animationId = requestAnimationFrame(draw); analyser.getByteFrequencyData(data);
                    this.renderCanvas(ctx, cv, data);
                    if(document.body.classList.contains('party-active')) this.renderCanvas(pCtx, pc, data, true);
                }; draw();
            }
            renderCanvas(ctx, cv, d, party=false) {
                ctx.clearRect(0,0,cv.width,cv.height); const acc = getComputedStyle(document.body).getPropertyValue('--accent-color').trim();
                ctx.fillStyle = ctx.strokeStyle = acc;
                if (this.visualizerType === 'bars') {
                    const bw = (cv.width/d.length)*2.5; let x = 0;
                    for(let i=0; i<d.length; i++) {
                        const bh = (d[i]/255)*cv.height*(party?0.8:0.4);
                        ctx.globalAlpha = party?0.6:0.2; ctx.fillRect(x,cv.height-bh,bw,bh); x += bw+1;
                    }
                } else if(this.visualizerType==='wave') {
                    ctx.beginPath(); ctx.lineWidth=2; const sw = cv.width/d.length; let x=0;
                    for(let i=0; i<d.length; i++) { const y=(d[i]/128.0)*cv.height/2; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); x+=sw; }
                    ctx.stroke();
                } else if(this.visualizerType==='circle') {
                    const cx=cv.width/2, cy=cv.height/2, rad=Math.min(cx,cy)/3;
                    ctx.beginPath(); for(let i=0; i<d.length; i++) {
                        const r=rad+(d[i]/255)*(party?100:50); const ang=(i/d.length)*Math.PI*2;
                        const x=cx+Math.cos(ang)*r, y=cy+Math.sin(ang)*r; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                    } ctx.closePath(); ctx.stroke();
                }
            }
            resize() {
                const cv = document.getElementById('main-visualizer'); if(cv){cv.width=cv.offsetWidth; cv.height=cv.offsetHeight;}
                const pc = document.getElementById('party-canvas'); if(pc){pc.width=window.innerWidth; pc.height=window.innerHeight;}
            }
            setVisualizer(t) { 
                this.visualizerType = t; 
                this.visTypes.forEach(v => {
                    const btn = document.getElementById(`vis-btn-${v}`);
                    if(btn) btn.className = `flex-1 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all ${v===t?'bg-accent text-black':'text-skin-text-dim hover:text-skin-text'}`;
                });
                
                // Update icon in party mode
                const icons = {'bars':'chart-simple', 'wave':'wave-square', 'circle':'circle-notch'};
                document.getElementById('party-vis-icon').className = `fa-solid fa-${icons[t]}`;
            }
            cycleVisualizer() {
                const currentIdx = this.visTypes.indexOf(this.visualizerType);
                const nextIdx = (currentIdx + 1) % this.visTypes.length;
                this.setVisualizer(this.visTypes[nextIdx]);
            }
            setAccent(hex) {
                let r=0,g=0,b=0;
                if(hex.length===7){r=parseInt(hex.slice(1,3),16);g=parseInt(hex.slice(3,5),16);b=parseInt(hex.slice(5,7),16);}
                document.documentElement.style.setProperty('--accent-color', `rgb(${r},${g},${b})`);
                document.documentElement.style.setProperty('--accent-dim', `rgba(${r},${g},${b},0.2)`);
            }
            togglePartyMode() { document.body.classList.toggle('party-active'); this.resize(); }
            updatePlayerDisplay(ch) {
                document.getElementById('player-title').textContent = ch.name;
                const img = document.getElementById('player-img'); const ph = document.getElementById('player-placeholder');
                const pLogo = document.getElementById('party-logo');
                if(ch.logo) { img.src = pLogo.src = ch.logo; img.classList.remove('hidden'); ph.classList.add('hidden'); pLogo.classList.remove('hidden'); }
                else { img.classList.add('hidden'); ph.classList.remove('hidden'); pLogo.classList.add('hidden'); }
                document.getElementById('party-track').textContent = ch.name;
                if(ch.color && ch.color !== "#000000") {
                    this.setAccent(ch.color);
                } else { 
                    this.setAccent('#22c55e'); 
                }
            }
            updatePlayBtn(playing) {
                const icon = document.getElementById('main-play-btn').querySelector('i');
                const pIcon = document.getElementById('party-play-icon');
                if(icon) icon.className = `fa-solid fa-${playing?'pause':'play ml-1'}`;
                if(pIcon) pIcon.className = `fa-solid fa-${playing?'pause':'play ml-1'}`;
            }
            openModal(id) { document.getElementById(id).classList.remove('hidden'); }
            closeModal(id) { document.getElementById(id).classList.add('hidden'); }
            openAddChannel() {
                const f = document.querySelector('#modal-channel form'); f.reset(); f.querySelector('[name="id"]').value = "";
                f.querySelector('[name="color"]').value = "#22c55e"; document.querySelector('#modal-channel h3').textContent = "Aggiungi Canale";
                this.openModal('modal-channel');
            }
            openEditChannel(id) {
                const ch = app.data.state.channels.find(c => c.id === id); if(!ch) return;
                const f = document.querySelector('#modal-channel form'); f.querySelector('[name="id"]').value = ch.id;
                f.querySelector('[name="name"]').value = ch.name; f.querySelector('[name="logo"]').value = ch.logo || '';
                f.querySelector('[name="color"]').value = ch.color || '#22c55e'; f.querySelector('[name="url"]').value = ch.url;
                document.querySelector('#modal-channel h3').textContent = "Modifica Canale"; this.openModal('modal-channel');
            }
            switchTab(t) {
                document.getElementById('view-library').classList.toggle('hidden', t!=='library');
                document.getElementById('view-global').classList.toggle('hidden', t==='library');
                document.getElementById('tab-btn-library').className = `text-lg font-bold ${t==='library'?'text-skin-text border-b-2 border-accent':'text-skin-text-dim border-transparent'} pb-2 transition-all`;
                document.getElementById('tab-btn-global').className = `text-lg font-bold ${t!=='library'?'text-skin-text border-b-2 border-accent':'text-skin-text-dim border-transparent'} pb-2 transition-all`;
            }
            toggleEqPanel() { document.getElementById('eq-panel').classList.toggle('hidden'); }
        }

        /** MODULE 3: DATA CONTROLLER **/
        class DataController {
            constructor() { this.state = { channels: [], schedules: [], skin: 'midnight' }; this.currentCh = null; }
            load() { 
                const s = localStorage.getItem('radiomaster_final_v1'); 
                if(s) this.state = JSON.parse(s);
                app.ui.setSkin(this.state.skin || 'midnight'); this.render();
            }
            save() { localStorage.setItem('radiomaster_final_v1', JSON.stringify(this.state)); this.render(); }
            saveChannel(e) {
                e.preventDefault(); const fd = new FormData(e.target); const id = fd.get('id');
                const data = { id: id ? parseInt(id) : Date.now(), name: fd.get('name'), logo: fd.get('logo'), url: fd.get('url'), color: fd.get('color') };
                if (id) { const i = this.state.channels.findIndex(c => c.id == id); if(i>-1) this.state.channels[i] = data; }
                else this.state.channels.push(data);
                this.save(); app.ui.closeModal('modal-channel');
                if(this.currentCh && this.currentCh.id == id) { this.currentCh = data; app.ui.updatePlayerDisplay(data); }
            }
            deleteChannel(id) { if(confirm("Eliminare definitivamente questa stazione?")) { this.state.channels = this.state.channels.filter(c => c.id !== id); this.save(); } }
            saveSchedule(e) {
                e.preventDefault(); const fd = new FormData(e.target);
                this.state.schedules.push({ id: Date.now(), time: fd.get('time'), channelId: parseInt(fd.get('channelId')) });
                this.save(); app.ui.closeModal('modal-schedule');
            }
            deleteSchedule(id) { this.state.schedules = this.state.schedules.filter(s => s.id !== id); this.save(); }
            render() {
                const list = document.getElementById('channel-list'); const sel = document.getElementById('schedule-select');
                if(!list || !sel) return;
                document.getElementById('library-count').textContent = `${this.state.channels.length} Stazioni`;
                list.innerHTML = ""; sel.innerHTML = "";
                this.state.channels.forEach(ch => {
                    const opt = document.createElement('option'); opt.value = ch.id; opt.textContent = ch.name; sel.appendChild(opt);
                    const el = document.createElement('div');
                    const active = this.currentCh?.id === ch.id;
                    el.className = `flex items-center p-3 rounded-2xl border cursor-pointer transition-all group ${active?'bg-accent/10 border-accent':'bg-skin-panel border-skin-border hover:border-accent'}`;
                    el.onclick = (e) => { if(!e.target.closest('button')) app.playChannel(ch.id); };
                    const logo = ch.logo ? `<img src="${ch.logo}" class="w-full h-full object-cover">` : `<i class="fa-solid fa-radio text-skin-text-dim"></i>`;
                    el.innerHTML = `
                        <div class="w-10 h-10 rounded-xl bg-black/20 overflow-hidden flex items-center justify-center mr-3 border border-skin-border shadow-inner">${logo}</div>
                        <div class="flex-1 min-w-0"><div class="font-bold text-sm text-skin-text truncate ${active?'text-accent':''}">${ch.name}</div></div>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="event.stopPropagation(); app.ui.openEditChannel(${ch.id})" class="w-7 h-7 rounded-lg bg-skin-border text-skin-text-dim hover:text-blue-500 transition-colors"><i class="fa-solid fa-pen text-[10px]"></i></button>
                            <button onclick="event.stopPropagation(); app.data.deleteChannel(${ch.id})" class="w-7 h-7 rounded-lg bg-skin-border text-skin-text-dim hover:text-red-500 transition-colors"><i class="fa-solid fa-trash text-[10px]"></i></button>
                        </div>
                    `;
                    list.appendChild(el);
                });
                const sl = document.getElementById('schedule-list'); if(!sl) return;
                sl.innerHTML = "";
                this.state.schedules.sort((a,b)=>a.time.localeCompare(b.time)).forEach(sch => {
                    const ch = this.state.channels.find(c => c.id === sch.channelId);
                    const el = document.createElement('div'); el.className = "flex justify-between items-center p-3 rounded-2xl bg-black/10 border border-skin-border";
                    el.innerHTML = `<div class="flex items-center gap-3"><span class="font-mono text-accent font-bold bg-accent/10 px-3 py-1 rounded-lg text-xs tracking-tighter">${sch.time}</span><span class="text-sm font-medium text-skin-text">${ch?ch.name:'Canale rimosso'}</span></div>
                        <button onclick="app.data.deleteSchedule(${sch.id})" class="text-skin-text-dim hover:text-red-500 p-2"><i class="fa-solid fa-times"></i></button>`;
                    sl.appendChild(el);
                });
            }
            export() {
                const blob = new Blob([JSON.stringify(this.state)], {type: 'application/json'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "radiomaster_backup.json"; a.click();
            }
            import(input) {
                const reader = new FileReader(); reader.onload = (e) => { try { this.state = JSON.parse(e.target.result); this.save(); location.reload(); } catch(err){alert("Errore file");} };
                reader.readAsText(input.files[0]);
            }
        }

        /** MODULE 4: API & PWA CONTROLLERS **/
        class ApiController {
            async search(q) {
                const l = document.getElementById('global-list'); l.innerHTML = '<div class="text-center py-6 text-accent"><i class="fa-solid fa-circle-notch fa-spin text-2xl"></i></div>';
                try {
                    const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?name=${encodeURIComponent(q)}&limit=15`);
                    const data = await res.json(); l.innerHTML = "";
                    if(data.length===0) l.innerHTML = '<div class="text-sm text-center text-skin-text-dim py-6">Nessun risultato.</div>';
                    data.forEach(st => {
                        const el = document.createElement('div'); el.className = "flex items-center justify-between p-3 rounded-2xl bg-black/10 border border-skin-border hover:border-accent/30 transition-colors";
                        el.innerHTML = `<div class="flex items-center gap-3 overflow-hidden"><img src="${st.favicon||''}" class="w-10 h-10 rounded-lg bg-black/20" onerror="this.src=''"><div class="truncate text-xs font-bold text-skin-text leading-tight">${st.name}</div></div>
                            <button onclick="app.api.addGlobal('${st.name.replace(/'/g,"\\'")}', '${st.url_resolved}', '${st.favicon}')" class="bg-accent text-black px-4 py-2 rounded-xl text-[10px] font-black uppercase">AGGIUNGI</button>`;
                        l.appendChild(el);
                    });
                } catch(e) { l.innerHTML = '<div class="text-red-500 text-xs text-center">Errore API</div>'; }
            }
            addGlobal(n, u, l) { app.data.state.channels.push({ id: Date.now(), name: n, url: u, logo: l, color: '#22c55e' }); app.data.save(); }
            async fetchMetaForForm() {
                const name = document.querySelector('input[name="name"]').value; if(!name) return;
                try {
                    const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?name=${encodeURIComponent(name)}&limit=1`);
                    const data = await res.json(); if(data.length > 0) {
                        document.querySelector('input[name="logo"]').value = data[0].favicon || '';
                        document.querySelector('input[name="url"]').value = data[0].url_resolved || '';
                    }
                } catch(e){}
            }
        }

        class PwaController {
            constructor() { this.deferredPrompt = null; }
            init() {
                this.generateManifest(); this.registerServiceWorker();
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault(); this.deferredPrompt = e;
                    const btn = document.getElementById('install-btn');
                    if(btn) {
                        btn.classList.remove('hidden');
                        btn.onclick = () => this.installApp();
                    }
                });
            }
            generateManifest() {
                const manifest = {
                    "name": "RadioMaster Ultimate",
                    "short_name": "RadioMaster",
                    "start_url": ".",
                    "display": "standalone",
                    "background_color": "#09090b",
                    "theme_color": "#22c55e",
                    "description": "Premium Radio Scheduler",
                    "icons": [{"src": "https://cdn-icons-png.flaticon.com/512/3075/3075848.png", "sizes": "512x512", "type": "image/png"}]
                };
                const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
                document.getElementById('manifest-placeholder').setAttribute('href', URL.createObjectURL(blob));
            }
            registerServiceWorker() {
                const swCode = `const CACHE='rm-v1'; self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])))); self.addEventListener('fetch',e=>e.respondWith(fetch(e.request).catch(()=>caches.match(e.request))));`;
                const blob = new Blob([swCode], {type: 'application/javascript'});
                if ('serviceWorker' in navigator) navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(() => {});
            }
            async installApp() {
                if (!this.deferredPrompt) return;
                this.deferredPrompt.prompt();
                const { outcome } = await this.deferredPrompt.userChoice;
                if (outcome === 'accepted') document.getElementById('install-btn').classList.add('hidden');
                this.deferredPrompt = null;
            }
        }

        /** MAIN APP CONTROLLER **/
        class RadioApp {
            constructor() { 
                this.audio = new AudioController(); this.ui = new UiController(); 
                this.data = new DataController(); this.api = new ApiController(); 
                this.pwa = new PwaController(); this.lastCheck = null;
                this.tools = {
                    sleepInterval: null,
                    setSleep() {
                        const min = parseInt(document.getElementById('sleep-input').value); if(!min) return;
                        let sec = min * 60; document.getElementById('sleep-countdown').classList.remove('hidden');
                        clearInterval(this.sleepInterval); this.sleepInterval = setInterval(() => {
                            sec--; const m = Math.floor(sec/60), s = sec%60;
                            document.getElementById('sleep-countdown').textContent = `${m}:${s<10?'0'+s:s}`;
                            if(sec<=0) { clearInterval(this.sleepInterval); app.audio.audioElement.pause(); document.getElementById('sleep-countdown').classList.add('hidden'); }
                        }, 1000);
                        document.getElementById('sleep-input').value = "";
                    },
                    cancelSleep() { clearInterval(this.sleepInterval); document.getElementById('sleep-countdown').classList.add('hidden'); }
                };
            }
            init() {
                this.data.load(); this.pwa.init();
                window.addEventListener('resize', () => this.ui.resize()); this.ui.resize();
                
                // Volume handlers
                const volHandler = (e) => {
                    const val = e.target.value;
                    this.audio.setVolume(val);
                    // Sync sliders
                    document.getElementById('vol-slider').value = val;
                    document.getElementById('party-vol-slider').value = val;
                };
                document.getElementById('vol-slider').addEventListener('input', volHandler);
                document.getElementById('party-vol-slider').addEventListener('input', volHandler);

                this.audio.audioElement.onplay = () => { this.ui.updatePlayBtn(true); this.ui.startVisualizer(this.audio.analyser); };
                this.audio.audioElement.onpause = () => this.ui.updatePlayBtn(false);
                
                // EQ Handlers
                ['low','mid','high'].forEach((t, i) => {
                    const el = document.getElementById(`eq-${t}`);
                    if(el) el.addEventListener('input', (e) => this.audio.setEq(i, e.target.value));
                });

                // Default Visualizer
                this.ui.setVisualizer('bars');

                // Scheduler Loop
                setInterval(() => {
                    const ts = new Date().toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'});
                    document.getElementById('clock-display').textContent = ts;
                    if(this.lastCheck !== ts) {
                        this.lastCheck = ts; const m = this.data.state.schedules.find(s => s.time === ts);
                        if(m) this.playChannel(m.channelId);
                    }
                }, 1000);
            }
            playChannel(id) {
                const ch = this.data.state.channels.find(c => c.id === id); if(!ch) return;
                this.data.currentCh = ch; this.data.render(); this.ui.updatePlayerDisplay(ch); this.audio.play(ch.url);
            }
            nextChannel() {
                if(this.data.state.channels.length === 0) return;
                const idx = this.data.state.channels.findIndex(c => c.id === this.data.currentCh?.id);
                const nextIdx = (idx + 1) % this.data.state.channels.length;
                this.playChannel(this.data.state.channels[nextIdx].id);
            }
            prevChannel() {
                if(this.data.state.channels.length === 0) return;
                const idx = this.data.state.channels.findIndex(c => c.id === this.data.currentCh?.id);
                const prevIdx = (idx - 1 + this.data.state.channels.length) % this.data.state.channels.length;
                this.playChannel(this.data.state.channels[prevIdx].id);
            }
        }

        const app = new RadioApp();
        window.addEventListener('load', () => app.init());
    </script>
</body>
</html>
